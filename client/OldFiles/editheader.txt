import React, { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { usePortfolio } from "../../../context/PortfolioContext";
import { savePortfolio } from "../../../api/portfolioAPI";
import UserProfileMenu from "../../../components/UserProfileMenu";
import { Monitor, Columns2, Smartphone, Menu } from "lucide-react";
import { useSplash } from "../../../context/SplashContext";
import ThemePopup from "./ThemePopup";
import ElementPopup from "./ElementPopup";
import TalentVisibilityPopup from "./TalentVisibilityPopup";

function EditHeader({ setViewMode, viewMode }) {
  const navigate = useNavigate();
  const location = useLocation();
  const { showSplash } = useSplash();
  const { portfolioData, setPortfolioData } = usePortfolio();

  const [menuOpen, setMenuOpen] = useState(false);
  const [showThemePopup, setShowThemePopup] = useState(false);
  const [showElementPopup, setShowElementPopup] = useState(false);
  const [showTalentPopup, setShowTalentPopup] = useState(false);

  const isCustomizePage = location.pathname.includes("/customize");

  const buildCleanData = () => ({
    ...portfolioData,
    template: portfolioData.template || "modern",
    skills: Array.isArray(portfolioData.skills) ? portfolioData.skills : [],
    projects: Array.isArray(portfolioData.projects) ? portfolioData.projects : [],
  });

  // Save handler (keeps behaviour you had)
  const handleSave = async () => {
    try {
      const cleanData = buildCleanData();
      await savePortfolio(cleanData);
      showSplash(1500);
    } catch (err) {
      console.error("Save error:", err);
    }
  };

  const handlePreview = async () => {
    try {
      const cleanData = buildCleanData();
      const res = await savePortfolio(cleanData);
      showSplash(1200, () => navigate(`/portfolio/${res.id}`));
    } catch (err) {
      console.error("Preview error:", err);
    }
  };

  // When user changes visibility via the header control, we want to open popup
  const handleSetVisibility = (isPublic) => {
    // immediately update UI locally
    setPortfolioData({ ...portfolioData, isPublic });
    // if making public, open popup so user can confirm linking to Find Talent
    if (isPublic) {
      setShowTalentPopup(true);
    } else {
      // if making private, persist change quietly
      savePortfolio({ ...buildCleanData(), isPublic: false }).catch(console.error);
    }
  };

  return (
    <header
      className={`${
        isCustomizePage ? "relative top-0 left-0 w-full" : "fixed top-0 left-0 w-full z-50"
      } bg-white text-black shadow-[0_4px_20px_rgba(0,0,0,0.08)]`}
    >
      <div className="flex items-center justify-between px-6 sm:px-10 py-3 border-b border-gray-200">
        {/* logo */}
        <div className="flex items-center gap-3 sm:gap-4">
          <img
            src="/white.png"
            alt="Foliofy Logo"
            className="w-24 sm:w-28 cursor-pointer p-1 rounded-lg object-contain"
            onClick={() => navigate("/")}
          />
        </div>

        {/* Desktop Buttons */}
        <div className="hidden md:flex items-center gap-4 scale-[1.0] origin-right">
          {/* compact group */}
          <div className="flex items-center gap-3 bg-gray-100 px-3 py-2 rounded-full border border-gray-300 shadow-sm">
            <button
              onClick={() => setShowThemePopup((p) => !p)}
              className="relative flex items-center justify-center bg-gradient-to-r from-purple-600 via-fuchsia-500 to-indigo-600 text-white px-4 py-1.5 rounded-full text-xs font-semibold shadow-md hover:scale-105 transition"
            >
              Themes
            </button>

            {/* View mode quick buttons */}
            <button
              onClick={() => setViewMode("mobile")}
              className={`p-1.5 rounded-full transition ${viewMode === "mobile" ? "bg-purple-600 text-white shadow-lg" : "hover:bg-gray-200 text-gray-700"}`}
              title="Mobile"
            >
              <Smartphone size={16} />
            </button>
            <button
              onClick={() => setViewMode("dual")}
              className={`p-1.5 rounded-full transition ${viewMode === "dual" ? "bg-purple-600 text-white shadow-lg" : "hover:bg-gray-200 text-gray-700"}`}
              title="Dual"
            >
              <Columns2 size={16} />
            </button>
            <button
              onClick={() => setViewMode("desktop")}
              className={`p-1.5 rounded-full transition ${viewMode === "desktop" ? "bg-purple-600 text-white shadow-lg" : "hover:bg-gray-200 text-gray-700"}`}
              title="Desktop"
            >
              <Monitor size={16} />
            </button>

            <button
              onClick={() => setShowElementPopup(true)}
              className="px-3 py-1.5 rounded-full text-xs font-semibold bg-white text-black border border-blue-500 hover:scale-[1.05] transition"
            >
              + Element
            </button>
          </div>

          {/* Visibility + Talent block */}
          <div className="flex items-center gap-3 bg-gray-100 px-3 py-2 rounded-full border border-gray-300 shadow-sm">
            {/* custom visibility switch (not default select) */}
            <div className="flex items-center gap-2 px-2 py-1 rounded-full bg-white/80 border border-gray-200">
              <span className="text-xs font-medium text-gray-600 px-2">Visibility</span>
              <div className="flex items-center bg-transparent gap-1">
                <button
                  onClick={() => handleSetVisibility(false)}
                  className={`px-2 py-1 text-xs rounded-full ${!portfolioData?.isPublic ? "bg-gray-700 text-white font-medium" : "hover:bg-gray-100"}`}
                >
                  Private
                </button>
                <button
                  onClick={() => handleSetVisibility(true)}
                  className={`px-2 py-1 text-xs rounded-full ${portfolioData?.isPublic ? "bg-purple-600 text-white font-medium" : "hover:bg-gray-100"}`}
                >
                  Public
                </button>
              </div>
            </div>

            {/* Talent button */}
            <button
              onClick={() => setShowTalentPopup(true)}
              className="relative px-4 py-1.5 rounded-full text-xs font-semibold bg-gradient-to-r from-black via-purple-900 to-black text-white shadow-md hover:scale-105 transition"
            >
              Talent
              <span className="absolute -top-2 -right-2 bg-red-500 text-[9px] text-white px-1.5 py-[1px] rounded-full animate-pulse">
                NEW
              </span>
            </button>
          </div>

          {/* theme pickers & reset */}
          <div className="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-full border border-gray-300 shadow-sm">
            <input
              type="color"
              value={portfolioData.themeBg || "#000000"}
              onChange={(e) => setPortfolioData({ ...portfolioData, themeBg: e.target.value })}
              className="w-7 h-7 rounded border"
              title="Background color"
            />
            <input
              type="color"
              value={portfolioData.themeFont || "#FFFFFF"}
              onChange={(e) => setPortfolioData({ ...portfolioData, themeFont: e.target.value })}
              className="w-7 h-7 rounded border"
              title="Font color"
            />

            <button
              onClick={async () => {
                const updated = { ...portfolioData, themeBg: "#000000", themeFont: "#FFFFFF" };
                setPortfolioData(updated);
                try { await savePortfolio(updated); showSplash(900); } catch (e) {console.error(e);}
              }}
              className="px-3 py-1 text-xs rounded-full bg-white border border-gray-300 hover:bg-gray-200 transition"
            >
              Reset
            </button>
          </div>

          {/* Deploy + Save */}
          <button
            onClick={handlePreview}
            className="rounded-full px-5 py-1.5 text-xs font-semibold bg-black text-white hover:bg-white hover:text-black border border-black transition"
          >
            Deploy
          </button>

          <button
            onClick={handleSave}
            className="rounded-full px-5 py-1.5 text-xs font-semibold bg-white text-black border hover:bg-black hover:text-white transition"
          >
            Save
          </button>

          <UserProfileMenu />
        </div>

        {/* Mobile Menu Icon */}
        <div className="md:hidden flex items-center gap-2">
          <button className="p-2" onClick={() => setMenuOpen((p) => !p)}>
            <Menu size={22} />
          </button>
        </div>
      </div>

      {/* Theme popup */}
      {showThemePopup && (
        <ThemePopup
          onSelect={(templateKey) => {
            setPortfolioData({ ...portfolioData, template: templateKey });
            navigate(`/customize/${templateKey}`);
            setShowThemePopup(false);
          }}
          onClose={() => setShowThemePopup(false)}
        />
      )}

      {/* Element popup */}
      {showElementPopup && <ElementPopup onClose={() => setShowElementPopup(false)} />}

      {/* Mobile glass menu */}
      {menuOpen && (
        <div
          className="md:hidden fixed top-16 right-4 w-60 bg-white/18 backdrop-blur-xl border border-white/30 shadow-2xl rounded-2xl p-4 flex flex-col gap-3 z-[999] animate-fadeIn"
        >
          <button
            onClick={handlePreview}
            className="px-4 py-2 rounded-lg bg-white/30 hover:bg-white/50 text-black text-sm transition"
          >
            ðŸš€ Deploy
          </button>

          <button
            onClick={handleSave}
            className="px-4 py-2 rounded-lg bg-white/30 hover:bg-white/50 text-black text-sm transition"
          >
            ðŸ’¾ Save
          </button>

          <button
            onClick={() => { setShowThemePopup(true); setMenuOpen(false); }}
            className="px-4 py-2 rounded-lg bg-white/30 hover:bg-white/50 text-black text-sm transition"
          >
            ðŸŽ¨ Themes
          </button>

          <button
            onClick={() => { setShowElementPopup(true); setMenuOpen(false); }}
            className="px-4 py-2 rounded-lg bg-white/30 hover:bg-white/50 text-black text-sm transition"
          >
            âž• Add Element
          </button>

          <button
            onClick={() => { setShowTalentPopup(true); setMenuOpen(false); }}
            className="px-4 py-2 rounded-lg bg-white/30 hover:bg-white/50 text-black text-sm transition"
          >
            ðŸŒŸ Find Talent
          </button>

          {/* simple mobile visibility */}
          <div className="flex items-center gap-2 mt-2">
            <button
              onClick={() => handleSetVisibility(true)}
              className={`flex-1 px-3 py-2 rounded-md ${portfolioData.isPublic ? "bg-purple-600 text-white" : "bg-white/10 text-black"}`}
            >
              Public
            </button>
            <button
              onClick={() => handleSetVisibility(false)}
              className={`flex-1 px-3 py-2 rounded-md ${!portfolioData.isPublic ? "bg-gray-100" : "bg-white/10"}`}
            >
              Private
            </button>
          </div>
        </div>
      )}

      {/* Talent popup (shared) */}
      {showTalentPopup && (
        <TalentVisibilityPopup
          isOpen={showTalentPopup}
          onClose={() => setShowTalentPopup(false)}
          portfolioData={portfolioData}
          setPortfolioData={setPortfolioData}
        />
      )}
    </header>
  );
}

export default EditHeader;
